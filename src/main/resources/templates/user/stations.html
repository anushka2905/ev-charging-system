<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Available Stations</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        table {
            border-collapse: collapse;
            width: 80%;
            margin: auto;
            margin-bottom: 30px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        a.btn {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        #map {
            height: 400px;
            width: 80%;
            margin: auto;
            margin-top: 30px;
            border: 1px solid #ccc;
        }
        .top-buttons {
            text-align: center;
            margin-bottom: 20px;
        }
        .top-buttons a {
            margin: 0 10px;
        }
    </style>
</head>
<body>

<h2 style="text-align:center;">Available Charging Stations</h2>

<div class="top-buttons">
    <a th:href="@{/users/dashboard}" class="btn" style="background-color: gray;">Return to Dashboard</a>
</div>

<table>
    <thead>
        <tr>
            <th>ID</th>
            <th>Station Name</th>
            <th>Location</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <tr th:each="station : ${stations}">
            <td th:text="${station.id}"></td>
            <td th:text="${station.name}"></td>
            <td th:text="${station.address}"></td>
            <td>
                <a th:href="@{'/users/stations/select/' + ${station.id}}" class="btn">View & Book</a>
                <a href="javascript:void(0)"
                   class="btn"
                   style="background-color: orange;"
                   th:attr="data-lat=${station.latitude}, 
                            data-lon=${station.longitude}, 
                            data-name=${station.name}, 
                            data-address=${station.address}"
                   onclick="viewMapFromButton(this)">View Map</a>
            </td>
        </tr>
    </tbody>
</table>

<h3 style="text-align:center;">All Stations Map</h3>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
    // Convert stations list to JavaScript array
    var stations = /*[[${stations}]]*/ [];

    // Initialize map centered on Bhopal
    var map = L.map('map').setView([23.2599, 77.4126], 13);

    // Base map tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Marker icons
    var defaultIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    });

    var redIcon = L.icon({
        iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    var markers = {};
    var highlightedMarker = null;

    // Add all station markers
    stations.forEach(function(station) {
        if (station.latitude && station.longitude) {
            var marker = L.marker([station.latitude, station.longitude], { icon: defaultIcon })
                .addTo(map)
                .bindPopup("<b>" + station.name + "</b><br/>" + station.address);

            markers[station.latitude + "," + station.longitude] = marker;
        }
    });

    // Function to zoom and highlight marker
    function viewMapFromButton(button) {
        var lat = parseFloat(button.getAttribute("data-lat"));
        var lon = parseFloat(button.getAttribute("data-lon"));
        var name = button.getAttribute("data-name");
        var address = button.getAttribute("data-address");

        map.setView([lat, lon], 15);

        // Reset previous highlight
        if (highlightedMarker) {
            highlightedMarker.setIcon(defaultIcon);
        }

        // Highlight new marker
        var key = lat + "," + lon;
        if (markers[key]) {
            markers[key].setIcon(redIcon).openPopup();
            highlightedMarker = markers[key];
        }
    }
/*]]>*/
</script>

</body>
</html>
